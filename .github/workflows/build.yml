name: Deploy to EC2

# Trigger this workflow on push to the master branch
on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy Node.js App to EC2
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3
        # This action fetches the repository content so we can deploy it

      # Step 2: SSH into the EC2 server and deploy
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}          # EC2 server IP or hostname
          username: ${{ secrets.EC2_USERNAME }}  # SSH username
          key: ${{ secrets.EC2_SSH_KEY }}        # Private SSH key stored in secrets
          port: 22                               # Default SSH port
          script: |
            echo "Navigating to project directory"
            cd ${{ secrets.PROJECT_PATH }}

            echo "Pulling latest code from master"
            git pull origin master

            echo "Installing dependencies"
            npm install

            echo "Checking if pm2 process exists"
            if pm2 list | grep -q "index"; then
              echo "Restarting existing pm2 process"
              pm2 restart index.js
            else
              echo "Starting pm2 process for the first time"
              pm2 start index.js --name index
            fi

            echo "Deployment completed successfully"
